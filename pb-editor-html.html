<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Picture Book Author Tools</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.snow.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .editor-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .stats-panel {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .feature-card {
            height: 100%;
            transition: transform 0.2s;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .icon-feature {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #5c7cfa;
        }
        .authentication-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .ql-editor {
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
        }
        .privacy-notice {
            font-size: 0.85rem;
            color: #6c757d;
            font-style: italic;
        }
        .btn-donate {
            background-color: #ff813f;
            color: white;
        }
        .btn-donate:hover {
            background-color: #e56e2c;
            color: white;
        }
        .word-cloud-container {
            height: 300px;
            background-color: white;
            border-radius: 8px;
            margin-top: 20px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #login-section {
            display: block;
        }
        #editor-section {
            display: none;
        }
        #word-freq-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        /* Art note styling */
        .art-note {
            color: #d9534f !important;
            font-style: italic !important;
            background-color: rgba(217, 83, 79, 0.1) !important;
            border-radius: 3px;
        }

        /* Readability analysis styling */
        .readability-results {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .metric-card {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4263eb;
        }
        .metric-label {
            color: #495057;
            font-size: 0.9rem;
        }
        .age-recommendation {
            background-color: #e3faff;
            border-left: 4px solid #00bcd4;
        }
        .reading-ease {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        .school-level {
            background-color: #e8f4ff;
            border-left: 4px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="fw-bold">Picture Book Author Tools</h1>
            <div>
                <a href="https://hellonathan.ca/nerdy-stuff-for-authors/pb-author-tools/" class="btn btn-outline-primary" target="_blank">
                    <i class="fab fa-google me-2"></i>Google Docs Add-on
                </a>
                <a href="https://buymeacoffee.com/hellonathanc" class="btn btn-donate ms-2" target="_blank">
                    <i class="fas fa-mug-hot me-2"></i>Buy Me a Coffee
                </a>
            </div>
        </header>

        <!-- Login Section -->
        <div id="login-section" class="authentication-panel">
            <div class="row">
                <div class="col-md-6">
                    <h3>Welcome to Picture Book Author Tools</h3>
                    <p>This tool helps picture book authors analyze their manuscripts, count words, and highlight art notes.</p>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item bg-transparent"><i class="fas fa-check-circle text-success me-2"></i>Count words (excluding art notes)</li>
                        <li class="list-group-item bg-transparent"><i class="fas fa-check-circle text-success me-2"></i>Detect and highlight art notes automatically</li>
                        <li class="list-group-item bg-transparent"><i class="fas fa-check-circle text-success me-2"></i>Generate word clouds and frequency lists</li>
                        <li class="list-group-item bg-transparent"><i class="fas fa-check-circle text-success me-2"></i>Count adverbs and detect problematic rhyming words</li>
                    </ul>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Your manuscript stays on your device. We never store or process your text on our servers.
                    </div>
                </div>
                <div class="col-md-6">
                    <div id="auth-panel" class="card">
                        <div class="card-body">
                          <!--<h4 class="card-title">Access Picture Book Author Tools</h4>-->
                          <div class="alert alert-info mb-3">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            By signing into this free tool, you agree to be subscribed to <a href="https://hellonathan.substack.com/" target="_blank" class="alert-link">Nathan Christopher's free Substack newsletter</a>
                          </div>

                          <!-- Login/Signup Tabs -->
                          <ul class="nav nav-tabs mb-3" id="auth-tabs" role="tablist">
                            <li class="nav-item" role="presentation">
                              <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-pane" type="button" role="tab">Log In</button>
                            </li>
                            <li class="nav-item" role="presentation">
                              <button class="nav-link" id="signup-tab" data-bs-toggle="tab" data-bs-target="#signup-pane" type="button" role="tab">Sign Up</button>
                            </li>
                          </ul>
                          
                          <!-- Tab Content -->
                          <div class="tab-content" id="auth-tab-content">
                            <!-- Login Pane -->
                            <div class="tab-pane fade show active" id="login-pane" role="tabpanel">
                              <form id="login-form">
                                <div class="mb-3">
                                  <label for="login-email" class="form-label">Email</label>
                                  <input type="email" class="form-control" id="login-email" required>
                                </div>
                                <div class="mb-3">
                                  <label for="login-password" class="form-label">Password</label>
                                  <input type="password" class="form-control" id="login-password" required>
                                </div>
                                <div class="d-grid mb-3">
                                  <button type="submit" class="btn btn-primary">Log In</button>
                                </div>
                                <div class="mb-3 text-center">
                                  <small><a href="#" id="forgot-password-link">Forgot Password?</a></small>
                                </div>
                              </form>
                              
                              <div class="text-center mb-3">
                                <small class="text-muted">Or log in with</small>
                              </div>
                              
                              <div class="d-grid gap-2">
                                <button id="google-login-btn" class="btn btn-outline-secondary">
                                  <i class="fab fa-google me-2"></i>Continue with Google
                                </button>
                              </div>
                            </div>
                            
                            <!-- Signup Pane -->
                            <div class="tab-pane fade" id="signup-pane" role="tabpanel">
                              <!--<div class="alert alert-info mb-3">
                                <i class="fas fa-check-circle me-2 text-success"></i>
                                By creating an account, you agree to be subscribed to <a href="https://hellonathan.substack.com/" target="_blank" class="alert-link">Nathan Christopher's free Substack newsletter</a>
                              </div>-->
                              <form id="signup-form">
                                <div class="mb-3">
                                  <label for="signup-email" class="form-label">Email</label>
                                  <input type="email" class="form-control" id="signup-email" required>
                                </div>
                                <div class="mb-3">
                                  <label for="signup-password" class="form-label">Password</label>
                                  <input type="password" class="form-control" id="signup-password" required>
                                </div>
                                <div class="d-grid mb-3">
                                  <button type="submit" class="btn btn-primary">Create Account</button>
                                </div>
                              </form>
                            </div>
                          </div>
                          
                          <div id="auth-message" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Editor Section (Hidden until logged in) -->
        <div id="editor-section">
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="editor-container">
                        <p class="text-muted small">Paste your text below. Art notes will be highlighted automatically.</p>
                        <div id="editor"></div>
                        <p class="privacy-notice mt-2">
                            <i class="fas fa-shield-alt me-1"></i> Your manuscript never leaves your browser. No text is sent to our servers or stored.
                        </p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-panel">
                        <h4>Manuscript Stats</h4>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Text Word Count:</span>
                            <span id="text-word-count" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Art Notes Word Count:</span>
                            <span id="art-notes-word-count" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total Word Count:</span>
                            <span id="total-word-count" class="fw-bold">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Number of Art Notes:</span>
                            <span id="art-notes-count" class="fw-bold">0</span>
                        </div>
                    </div>
                    
                    <div class="accordion" id="featuresAccordion">
                        <!-- NEW READABILITY ANALYSIS ACCORDION ITEM -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#readabilityCollapse">
                                    <i class="fas fa-book-reader me-2"></i> Readability Analysis
                                </button>
                            </h2>
                            <div id="readabilityCollapse" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                                <div class="accordion-body">
                                    <button id="analyze-readability" class="btn btn-sm btn-primary mb-3">Analyze Readability</button>
                                    <div class="readability-results" style="display: none;" id="readability-results">
                                        <div class="row">
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="word-count">0</div>
                                                    <div class="metric-label">Word Count</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="sentence-count">0</div>
                                                    <div class="metric-label">Sentence Count</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="avg-words-per-sentence">0</div>
                                                    <div class="metric-label">Avg Words Per Sentence</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="avg-syllables-per-word">0</div>
                                                    <div class="metric-label">Avg Syllables Per Word</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="flesch-kincaid-grade">0</div>
                                                    <div class="metric-label">Grade Level</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="flesch-reading-ease">0</div>
                                                    <div class="metric-label">Reading Ease Score</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card">
                                                    <div class="metric-value" id="complex-word-percentage">0%</div>
                                                    <div class="metric-label">Complex Words (3+ syllables)</div>
                                                </div>
                                            </div>
                                            <!--<div class="col-md-6 mb-2">
                                                <div class="metric-card reading-ease">
                                                    <div class="metric-value" id="reading-ease-category">-</div>
                                                    <div class="metric-label">Reading Ease Category</div>
                                                </div>
                                            </div>-->
                                            <div class="col-md-6 mb-2">
                                                <div class="metric-card school-level">
                                                    <div class="metric-value" id="school-level">-</div>
                                                    <div class="metric-label">School Level</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wordCloudCollapse">
                                    <i class="fas fa-cloud me-2"></i> Word Cloud
                                </button>
                            </h2>
                            <div id="wordCloudCollapse" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                                <div class="accordion-body">
                                    <button id="generate-word-cloud" class="btn btn-sm btn-primary mb-2">Generate Word Cloud</button>
                                    <div id="word-cloud-container" class="word-cloud-container"></div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#wordFrequencyCollapse">
                                    <i class="fas fa-list-ol me-2"></i> Word Frequency
                                </button>
                            </h2>
                            <div id="wordFrequencyCollapse" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                                <div class="accordion-body">
                                    <button id="generate-word-freq" class="btn btn-sm btn-primary mb-2">Generate Frequency List</button>
                                    <div id="word-freq-list" class="list-group">
                                        <!-- Word frequency items will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#adverbsCollapse">
                                    <i class="fas fa-highlighter me-2"></i> Adverb Detector
                                </button>
                            </h2>
                            <div id="adverbsCollapse" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                                <div class="accordion-body">
                                    <button id="detect-adverbs" class="btn btn-sm btn-primary mb-2">Detect Adverbs</button>
                                    <div id="adverbs-list" class="list-group">
                                        <!-- Adverbs will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rhymeWordsCollapse">
                                    <i class="fas fa-music me-2"></i> Rhyme Tool
                                </button>
                            </h2>
                            <div id="rhymeWordsCollapse" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                                <div class="accordion-body">
                                    <p class="text-muted small mb-3">
                                        This tool detects words that are syllabically ambiguous or may have different pronunciations 
                                        depending on regional accents, dialects, or reading styles. These words can cause issues 
                                        in rhyming picture books when used as end rhymes.
                                    </p>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="only-line-endings" checked>
                                        <label class="form-check-label" for="only-line-endings">
                                            Only detect at line or sentence endings 
                                            <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" title="When checked, only finds problematic rhyming words that appear at the end of lines or sentences - where they would typically be used as rhymes."></i>
                                        </label>
                                    </div>
                                    <button id="detect-rhyme-words" class="btn btn-sm btn-primary mb-2">Detect Problematic Rhyme Words</button>
                                    <div id="rhyme-words-list" class="list-group">
                                        <!-- Rhyme words will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#deleteArtNotesCollapse">
                                    <i class="fas fa-trash-alt me-2"></i> Remove Art Notes
                                </button>
                            </h2>
                            <div id="deleteArtNotesCollapse" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                                <div class="accordion-body">
                                    <p class="text-muted small mb-3">
                                        This tool allows you to completely remove all art notes from your manuscript.
                                        Useful when you need a clean version without any illustrator notes.
                                    </p>
                                    <button id="delete-art-notes" class="btn btn-outline-secondary btn-sm">
                                        <i class="fas fa-trash-alt me-2"></i>Delete All Art Notes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Overview -->
        <div class="row mb-4 mt-3">
            <div class="col-12">
                <h3 class="mb-4">Features to Help Picture Book Authors</h3>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-calculator icon-feature"></i>
                        <h5 class="card-title">Word Count</h5>
                        <p class="card-text">Automatically separates your manuscript text from art notes for accurate word counts.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-book-reader icon-feature"></i>
                        <h5 class="card-title">Readability Analysis</h5>
                        <p class="card-text">Analyze your text's grade level and age appropriateness with Flesch-Kincaid metrics.</p>
                    </div>
                </div>
            </div>
            <!--<div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-paint-brush icon-feature"></i>
                        <h5 class="card-title">Art Note Highlighting</h5>
                        <p class="card-text">Instantly identifies and highlights art notes as you type or paste your manuscript.</p>
                    </div>
                </div>
            </div>-->
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="fas fa-cloud icon-feature"></i>
                        <h5 class="card-title">More cool tools</h5>
                        <p class="card-text">Generate word clouds, frequency lists, and identify adverbs or problematic rhyming words.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-5 pt-4 border-top">
            <div class="row">
                <div class="col-md-6">
                    <h5>Picture Book Author Tools</h5>
                    <p class="text-muted">Created by Nathan Christopher</p>
                    <p><a href="https://hellonathan.ca/nerdy-stuff-for-authors/pb-author-tools/" target="_blank">Learn more about the Google Docs Add-on</a></p>
                </div>
                <div class="col-md-6 text-md-end">
                    <a href="https://twitter.com/HelloNathanC" class="text-decoration-none me-3" target="_blank">
                        <i class="fab fa-twitter"></i> Twitter
                    </a>
                    <a href="https://discord.com/invite/KSYfkNg" class="text-decoration-none me-3" target="_blank">
                        <i class="fab fa-discord"></i> Discord
                    </a>
                    <a href="https://hellonathan.substack.com" class="text-decoration-none me-3" target="_blank">
                        <i class="fas fa-newspaper"></i> Substack
                    </a>
                    <a href="https://buymeacoffee.com/hellonathanc" class="text-decoration-none" target="_blank">
                        <i class="fas fa-mug-hot"></i> Buy Me a Coffee
                    </a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Add Modal HTML for Art Note Deletion -->
    <div class="modal fade" id="noArtNotesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">No Art Notes Found</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-info-circle text-info" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center">No art notes were found in your manuscript.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center" id="confirm-delete-text">Are you sure you want to delete all art notes from your manuscript? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete All Art Notes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="successDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center" id="success-delete-text">Successfully removed art notes from your manuscript.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add your JavaScript functions here -->
    <script>
        // Load scripts
        document.write(`
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"><\/script>
            <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0-rc.2/dist/quill.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.4/d3.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.5/d3.layout.cloud.min.js"><\/script>
            <!-- Firebase SDKs -->
            <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"><\/script>
            <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"><\/script>
            <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"><\/script>
        `);


        // Readability Analysis Module
        class ReadabilityAnalyzer {
            // Syllable Counting Function
            static countSyllables(word) {
                // Trim and convert to lowercase
                word = word.toLowerCase().trim();
                
                // Remove non-alphabetic characters
                word = word.replace(/[^a-z]/g, '');
                
                // If word is empty, return 0
                if (word.length === 0) return 0;
                
                // Truly irregular words (rare exceptions)
                const specialCases = {
                    'colonel': 3,    // unique pronunciation
                    'lengthwise': 2, // tricky syllable structure
                    'squirrel': 2    // non-standard syllable break
                };
                
                // Check special cases first
                if (specialCases.hasOwnProperty(word)) {
                    return specialCases[word];
                }
                
                // Preprocessing rules
                // 1. Handle silent 'e' at the end
                if (word.endsWith('e')) {
                    // Remove silent 'e' for syllable counting, but with exceptions
                    const exceptions = ['le', 'age', 'ige'];
                    if (!exceptions.some(ex => word.endsWith(ex))) {
                        word = word.slice(0, -1);
                    }
                }
                
                // Improved vowel group detection
                // This regex looks for sequences of vowels that create distinct syllables
                const syllableMatches = word.match(/[aeiouy]+/g) || [];
                
                // Base syllable count from vowel groups
                let syllableCount = syllableMatches.length;
                
                // Adjust for specific phonetic rules
                // Diphthongs and triphthongs often count as one syllable
                const diphthongs = ['ai', 'au', 'ea', 'ee', 'ei', 'ie', 'oa', 'oe', 'oo', 'ou'];
                const complexVowelReduction = syllableMatches.filter(group => 
                    diphthongs.includes(group) || group.length > 2
                ).length;
                
                // Adjust syllable count
                syllableCount -= complexVowelReduction;
                
                // Sophisticated handling of 'io' combinations
                // Context-aware syllable adjustment
                const complexWordPatterns = [
                    // Patterns where 'io' is part of a single syllable
                    /[aeiou]tion$/,   // action, fiction
                    /^[aeiou]nion/,   // onion
                    
                    // Patterns where 'io' might split into two syllables
                    /^li[oa]n/        // lion
                ];
                
                // Check if the word matches any of these patterns
                const matchedPattern = complexWordPatterns.some(pattern => pattern.test(word));
                
                // Adjust syllable count based on pattern matching
                if (matchedPattern) {
                    if (/^li[oa]n/.test(word)) {
                        // Specifically handle words like 'lion'
                        syllableCount++;
                    } else if (/[aeiou]tion$/.test(word) || /^[aeiou]nion/.test(word)) {
                        // Ensure correct syllable count for words like 'action', 'onion'
                        syllableCount = syllableCount;
                    }
                }
                
                // Ensure at least one syllable
                syllableCount = Math.max(1, syllableCount);
                
                // Prevent unreasonably high syllable counts
                syllableCount = Math.min(syllableCount, word.length);
                
                return syllableCount;
            }

            // Utility function to remove art notes and clean text
            static removeArtNotes(text) {
                // Remove text within square brackets or parentheses that might be art notes
                return text.replace(/\[.*?\]|\(.*?\)/g, '');
            }

            // Utility function to get words from text
            static getWordsFromText(text) {
                // Clean the text and split into words
                return text.toLowerCase()
                    .replace(/["".,\/#—!$%\^&\*;:{}=\_`''~()?"…\[\]]/g, ' ')
                    .replace(/(^|\s)-|-(\s|$)/g, ' ')
                    .replace(/\s{2,}/g, ' ')
                    .trim()
                    .split(/\s+/);
            }

            // Analyze Readability
            static analyze(text) {
                // Remove art notes and clean text
                const cleanText = this.removeArtNotes(text);
                
                // Split into sentences and words
                const sentences = cleanText.split(/[.!?]+/).filter(s => s.trim().length > 0);
                const words = this.getWordsFromText(cleanText);
                
                // Basic metrics
                const totalSentences = sentences.length;
                const totalWords = words.length;
                const totalSyllables = words.reduce((sum, word) => sum + this.countSyllables(word), 0);
                
                // Prevent division by zero
                if (totalSentences === 0 || totalWords === 0) {
                    return {
                        totalWords: 0,
                        totalSentences: 0,
                        averageWordsPerSentence: 0,
                        averageSyllablesPerWord: 0,
                        fleschKincaidGradeLevel: 0,
                        fleschReadingEase: 0,
                        complexWordPercentage: 0,
                        //readingEaseCategory: 'N/A',
                        schoolLevel: 'N/A'
                    };
                }
                
                // Calculations
                const averageWordsPerSentence = totalWords / totalSentences;
                const averageSyllablesPerWord = totalSyllables / totalWords;
                
                // Flesch-Kincaid Grade Level Formula
                const fleschKincaidGradeLevel = 
                    0.39 * (totalWords / totalSentences) + 
                    11.8 * (totalSyllables / totalWords) - 
                    15.59;
                
                // Flesch Reading Ease Formula
                const fleschReadingEase = 
                    206.835 - 
                    (1.015 * (totalWords / totalSentences)) - 
                    (84.6 * (totalSyllables / totalWords));
                
                // Complex word percentage (words with 3+ syllables)
                const complexWords = words.filter(word => this.countSyllables(word) >= 3);
                const complexWordPercentage = (complexWords.length / totalWords) * 100;
                
                // Reading ease category
                //let readingEaseCategory = 'Unknown';
                
                // Flesch Reading Ease categorization
                /*if (fleschReadingEase >= 90) readingEaseCategory = 'Very Easy';
                else if (fleschReadingEase >= 80) readingEaseCategory = 'Easy';
                else if (fleschReadingEase >= 70) readingEaseCategory = 'Fairly Easy';
                else if (fleschReadingEase >= 60) readingEaseCategory = 'Standard';
                else if (fleschReadingEase >= 50) readingEaseCategory = 'Fairly Difficult';
                else if (fleschReadingEase >= 30) readingEaseCategory = 'Difficult';
                else readingEaseCategory = 'Very Difficult';*/
                
                // School level based on Flesch Reading Ease
                let schoolLevel = 'Unknown';
                if (fleschReadingEase >= 90) schoolLevel = '5th Grade';
                else if (fleschReadingEase >= 80) schoolLevel = '6th Grade';
                else if (fleschReadingEase >= 70) schoolLevel = '7th Grade';
                else if (fleschReadingEase >= 60) schoolLevel = '8-9th Grade';
                else if (fleschReadingEase >= 50) schoolLevel = '10-12th Grade';
                else if (fleschReadingEase >= 30) schoolLevel = 'College';
                else schoolLevel = 'College Graduate';
                
                return {
                    totalWords,
                    totalSentences,
                    averageWordsPerSentence: averageWordsPerSentence.toFixed(1),
                    averageSyllablesPerWord: averageSyllablesPerWord.toFixed(1),
                    fleschKincaidGradeLevel: fleschKincaidGradeLevel.toFixed(1),
                    fleschReadingEase: fleschReadingEase.toFixed(1),
                    complexWordPercentage: complexWordPercentage.toFixed(1),
                    //readingEaseCategory,
                    schoolLevel
                };
            }
        }

        // Debounce function to limit how often a function is called
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', function() {

            const firebaseConfig = {
                apiKey: "AIzaSyDjl1-5F3IJ38TZZCK4IiW7PiapdEkTmI4",
                authDomain: "pb-author-tools-542ca.firebaseapp.com",
                projectId: "pb-author-tools-542ca",
                storageBucket: "pb-author-tools-542ca.firebasestorage.app",
                messagingSenderId: "847283609320",
                appId: "1:847283609320:web:0349f755d64e89b277335d",
                measurementId: "G-6P7RCTZ8NX"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);  

            // Set up the readability analysis feature
            document.getElementById('analyze-readability').addEventListener('click', function() {
                // Get text from the editor (excluding art notes)
                const text = getPlainTextFromEditor();
                
                // Show the results container
                const resultsContainer = document.getElementById('readability-results');
                resultsContainer.style.display = 'block';
                
                // Run the analysis
                const results = ReadabilityAnalyzer.analyze(text);
                
                // Update the UI with the results
                document.getElementById('word-count').textContent = results.totalWords;
                document.getElementById('sentence-count').textContent = results.totalSentences;
                document.getElementById('avg-words-per-sentence').textContent = results.averageWordsPerSentence;
                document.getElementById('avg-syllables-per-word').textContent = results.averageSyllablesPerWord;
                document.getElementById('flesch-kincaid-grade').textContent = results.fleschKincaidGradeLevel;
                document.getElementById('flesch-reading-ease').textContent = results.fleschReadingEase;
                document.getElementById('complex-word-percentage').textContent = results.complexWordPercentage + '%';
                //document.getElementById('reading-ease-category').textContent = results.readingEaseCategory;
                document.getElementById('school-level').textContent = results.schoolLevel;
                
                // Add helpful context based on the results
                const gradeLevel = parseFloat(results.fleschKincaidGradeLevel);
                const readingEase = parseFloat(results.fleschReadingEase);
                
                // Add color coding based on grade level appropriateness for picture books
                const gradeElement = document.getElementById('flesch-kincaid-grade');
                if (gradeLevel <= 3) {
                    gradeElement.style.color = '#28a745'; // Green - appropriate for picture books
                } else if (gradeLevel <= 4.5) {
                    gradeElement.style.color = '#fd7e14'; // Orange - might be challenging
                } else {
                    gradeElement.style.color = '#dc3545'; // Red - likely too complex
                }
                
                // Add color coding for reading ease
                const easeElement = document.getElementById('flesch-reading-ease');
                if (readingEase >= 80) {
                    easeElement.style.color = '#28a745'; // Green - very easy to read
                } else if (readingEase >= 60) {
                    easeElement.style.color = '#fd7e14'; // Orange - moderately easy
                } else {
                    easeElement.style.color = '#dc3545'; // Red - difficult
                }
            });

            // Initialize Quill editor
            const quill = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'align': [] }],
                        ['clean']
                    ],
                    keyboard: {
                        bindings: {
                            'enter': {
                                key: 13,
                                handler: function(range) {
                                    // Only add one newline at a time
                                    quill.insertText(range.index, '\n');
                                    return false;
                                }
                            }
                        }
                    }
                },
                placeholder: 'Paste your picture book manuscript here...'
            });

            // Art note detection regex patterns
            // These patterns detect art notes, including those that span multiple lines
            const bracketArtNoteRegex = /\[([\s\S]*?)\]/g;
            const parenArtNoteRegex = /\((?:[\s\S]*?art note[\s\S]*?|[\s\S]*?illus[\s\S]*?|[\s\S]*?illo[\s\S]*?|[\s\S]*?illustration note[\s\S]*?|[\s\S]*?action note[\s\S]*?)\)/gi;

            // Lists of special words for detection
            const adverbList = [
                "abnormally", "abruptly", "absently", "absentmindedly", "absolutely", "accusingly", "actually", 
                "adorably", "amazingly", "angrily", "annoyingly", "anxiously", "arrogantly", "awfully", 
                "awkwardly", "badly", "bashfully", "beautifully", "bitterly", "bleakly", "blissfully", 
                "boastfully", "boldly", "bossily", "bravely", "breathlessly", "brilliantly", "brightly", 
                "calmly", "carefully", "carelessly", "cautiously", "certainly", "cheerfully", "cheekily", 
                "childishly", "clearly", "cleverly", "closely", "coaxingly", "colorfully", "completely", 
                "coolly", "courageously", "crazily", "crossly", "cruelly", "curiously", "daintily", 
                "daringly", "dazzlingly", "deceivingly", "deeply", "defiantly", "definitely", "delightfully", 
                "demandingly", "depressingly", "desperately", "determinedly", "diligently", "disappointingly", 
                "disgustingly", "distressingly", "doubtfully", "dramatically", "dreamily", "drowsily", "dully", 
                "eagerly", "easily", "ecstatically", "effortlessly", "elegantly", "embarrassingly", "emotionally", 
                "energetically", "enormously", "enthusiastically", "entirely", "enviously", "exactly", 
                "excessively", "exceptionally", "excitedly", "exhaustingly", "expressively", "extremely", 
                "faithfully", "fantastically", "fearfully", "ferociously", "fervently", "fiercely", "flamboyantly", 
                "flatly", "fondly", "foolishly", "forcefully", "forgetfully", "frankly", "frantically", "freely", 
                "frenetically", "frenziedly", "frightfully", "frustratingly", "funnily", "furiously", "furtively", 
                "generously", "gently", "giggly", "gingerly", "gladly", "gleefully", "gloomily", "goofily", 
                "gracefully", "graciously", "grandly", "gratefully", "greedily", "grouchily", "grumpily", 
                "haphazardly", "happily", "harshly", "hastily", "heartily", "heavily", "helpfully", "helplessly", 
                "hesitatingly", "hilariously", "highly", "honestly", "hopelessly", "horribly", "hugely", 
                "humorously", "hungrily", "hurriedly", "hysterically", "ignorantly", "immensely", "impatiently", 
                "impressively", "impulsively", "incredibly", "indignantly", "infuriatingly", "innocently", 
                "inquisitively", "insanely", "insistently", "instantly", "intensely", "intently", "interestingly", 
                "inwardly", "irritably", "irritatingly", "jaggedly", "jealously", "jokingly", "jovially", 
                "joyfully", "joylessly", "joyously", "jubilantly", "judgmentally", "jumpily", "justly", "keenly", 
                "kiddingly", "kindheartedly", "kindly", "knavishly", "knowingly", "knowledgeably", "kookily", 
                "lazily", "lightly", "limply", "listlessly", "lively", "loftily", "longingly", "loosely", 
                "loudly", "lovably", "lovingly", "loyally", "madly", "magically", "majestically", "marvelously", 
                "meaningfully", "mechanically", "menacingly", "merrily", "messily", "mightily", "miserably", 
                "mockingly", "moodily", "mortally", "mysteriously", "nastily", "naturally", "naughtily", 
                "neatly", "nervously", "nicely", "noisily", "noticeably", "obediently", "obnoxiously", 
                "oddly", "offensively", "optimistically", "outrageously", "overconfidently", "painfully", 
                "passionately", "patiently", "peculiarly", "perfectly", "persistently", "persuasively", 
                "petulantly", "physically", "piteously", "pitifully", "playfully", "pleasantly", "politely", 
                "poorly", "positively", "possessively", "potentially", "poutingly", "powerfully", "preciously", 
                "precisely", "profusely", "promptly", "properly", "protectively", "proudly", "punctually", 
                "puzzlingly", "quaintly", "queasily", "questionably", "queerly", "quicker", "quickly", "quietly", 
                "quirkily", "quirky", "quizzically", "ragingly", "randomly", "rapidly", "rashly", "ravenously", 
                "readily", "reassuringly", "recklessly", "regularly", "reluctantly", "remarkably", "repeatedly", 
                "reproachfully", "resentfully", "restfully", "restlessly", "righteously", "rightfully", 
                "ridiculously", "rigidly", "roughly", "rudely", "sadly", "safely", "sarcastically", "sassily", 
                "savagely", "scarcely", "scaredly", "scarily", "scornfully", "searchingly", "secretively", 
                "sedately", "seemingly", "seldom", "selfishly", "separately", "seriously", "shakily", "sharply", 
                "sheepishly", "shockingly", "shrilly", "shyly", "significantly", "silently", "simply", "sincerely", 
                "sleepily", "slightly", "sloppily", "sluggishly", "slyly", "slowly", "smoothly", "sneakily", 
                "softly", "solemnly", "solidly", "sourly", "speedily", "splendidly", "squeakily", "stealthily", 
                "sternly", "stiffly", "strangely", "strictly", "strongly", "stubbornly", "stunningly", "stupidly", 
                "subtly", "successfully", "suddenly", "sulkily", "super", "supposedly", "surprisingly", 
                "suspiciously", "sweetly", "swiftly", "sympathetically", "tantalizingly", "teasingly", "tenderly", 
                "tensely", "terribly", "terrifically", "thoughtfully", "thoughtlessly", "thrillingly", "tightly", 
                "timidly", "tiredly", "tremendously", "triumphantly", "truly", "truthfully", "unabashedly", 
                "unaccountably", "unbearably", "uncomfortably", "understandably", "understandingly", "uneasily", 
                "unethically", "unexpectedly", "unfortunately", "unhappily", "unimpressively", "unnaturally", 
                "unnecessarily", "unquestionably", "unusually", "unwillingly", "urgently", "uselessly", "usually", 
                "utterly", "vacantly", "vaguely", "vainly", "valiantly", "vastly", "vehemently", "verbally", 
                "viciously", "victoriously", "vigorously", "violently", "visibly", "vivaciously", "voluntarily", 
                "warmly", "weakly", "wearily", "wetly", "wholeheartedly", "wholly", "wildly", "willfully", 
                "willingly", "wisely", "wobbly", "woefully", "wonderfully", "worriedly", "wrongly", "yawningly", 
                "yearly", "yearningly", "yieldingly", "youthfully", "zealously", "zestfully", "zestily"
            ];

            const problematicRhymeWords = ["actually", "adult", "advertisement", "again", "apricot", "aunt", "buyer", "camera", "caramel", "caribbean", "chocolate", "choir", "comfortable", "crayon", "cyan", "data", "different", "drawer", "either", "envelope", "everything", "every", "extraordinary", "family", "favorite", "file", "finally", "fire", "fired", "flower", "genuine", "glorious", "gnarled", "grocery", "hour", "idea", "into", "interesting", "iron", "laboratory", "layer", "liar", "library", "loyal", "mature", "mayonnaise", "mirror", "mischievous", "neither", "oil", "orange", "our", "pecan", "pile", "poem", "power", "probably", "rather", "real", "restaurant", "roof", "route", "royal", "scone", "school", "schools", "schoolhouse", "separate", "shower", "sizzling", "smile", "squirrel", "steal", "steel", "style", "sure", "theatre", "theater", "tire", "tired", "toward", "vase", "while", "wild"];
            
            // Stop words for word cloud and frequency
            const stopWords = [
                "a", "able", "about", "across", "after", "all", "almost", "also", "am", "among", "an",
                "and", "any", "are", "as", "at", "be", "because", "been", "but", "by", "can", "cannot",
                "could", "did", "do", "does", "either", "else", "ever", "every", "for", "from", "get",
                "got", "had", "has", "have", "he", "her", "hers", "him", "his", "how", "however", "i",
                "if", "in", "into", "is", "it", "its", "just", "least", "let", "like", "likely", "may",
                "me", "might", "most", "must", "my", "neither", "no", "nor", "not", "of", "off", "often",
                "on", "only", "or", "other", "our", "own", "rather", "said", "say", "says", "she", "should",
                "since", "so", "some", "than", "that", "the", "their", "them", "then", "there", "these",
                "they", "this", "tis", "to", "too", "twas", "us", "wants", "was", "we", "were", "what",
                "when", "where", "which", "while", "who", "whom", "why", "will", "with", "would", "yet",
                "you", "your", "illo", "illus"
            ];
            
            // Function to show editor section
            function showEditorSection(email) {
                console.log("Showing editor section for", email);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('editor-section').style.display = 'block';
                
                // Add logout button
                addLogoutButton();
            }

            // Check if user is already logged in
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // User is signed in
                    console.log("User signed in:", user.email);
                    showEditorSection(user.email);
                    
                    // Check or create user document in Firestore
                    const userRef = firebase.firestore().collection('users').doc(user.uid);
                    userRef.get().then((doc) => {
                    if (!doc.exists) {
                        // Create new user document
                        userRef.set({
                        email: user.email,
                        //newsletter_subscribed: true,
                        signup_date: firebase.firestore.FieldValue.serverTimestamp(),
                        //added_to_substack: false
                        });
                    }
                    });
                } else {
                    // No user is signed in
                    console.log("No user signed in");
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('editor-section').style.display = 'none';
                }
            });        

            // Word cloud generation
            document.getElementById('generate-word-cloud').addEventListener('click', function() {
                const text = getPlainTextFromEditor();
                const wordFrequencies = getWordFrequencies(text);
                generateWordCloud(wordFrequencies, 'word-cloud-container');
            });

            // Word frequency list
            document.getElementById('generate-word-freq').addEventListener('click', function() {
                const text = getPlainTextFromEditor();
                const wordFrequencies = getWordFrequencies(text);
                displayWordFrequencies(wordFrequencies);
            });

            // Adverb detection
            document.getElementById('detect-adverbs').addEventListener('click', function() {
                const text = getPlainTextFromEditor();
                const adverbsFound = detectSpecialWords(text, adverbList);
                displaySpecialWordsList(adverbsFound, 'adverbs-list', 'Adverbs');
            });

            // Problematic rhyme words detection
            document.getElementById('detect-rhyme-words').addEventListener('click', function() {
                const text = getPlainTextFromEditor();
                const onlyLineEndings = document.getElementById('only-line-endings').checked;
                
                if (onlyLineEndings) {
                    // Filter for problematic rhyme words at line/sentence endings
                    const rhymeWordsFound = detectRhymeWordsAtEndings(text, problematicRhymeWords);
                    displaySpecialWordsList(rhymeWordsFound, 'rhyme-words-list', 'Syllabically ambiguous words at line/sentence endings');
                } else {
                    // Original function for finding anywhere in text
                    const rhymeWordsFound = detectSpecialWords(text, problematicRhymeWords);
                    displaySpecialWordsList(rhymeWordsFound, 'rhyme-words-list', 'Syllabically ambiguous words');
                }
            });

            // New function to detect rhyme words specifically at line or sentence endings
            function detectRhymeWordsAtEndings(text, wordList) {
                // Remove art notes from the text first
                const textWithoutArtNotes = removeArtNotes(text);
                
                // Split text into lines
                const lines = textWithoutArtNotes.split(/\r?\n/).filter(line => line.trim() !== '');
                
                // Track problematic words and their positions
                const problematicWords = {};
                
                // Check each problematic word
                wordList.forEach(targetWord => {
                    let totalCount = 0;
                    
                    // Check for line endings
                    lines.forEach(line => {
                        const lastWord = getLastWord(line);
                        if (lastWord && lastWord.toLowerCase() === targetWord.toLowerCase()) {
                            // Found the word at a line ending
                            totalCount++;
                        }
                    });
                    
                    // Check for sentence endings that aren't also line endings
                    const sentenceRegex = new RegExp(`[^.!?]+\\b${targetWord}\\b[.!?]+`, 'gi');
                    let match;
                    
                    while ((match = sentenceRegex.exec(textWithoutArtNotes)) !== null) {
                        const sentence = match[0];
                        // Check if this is a sentence that doesn't end a line
                        const isAlsoLineEnding = lines.some(line => 
                            line.toLowerCase().includes(targetWord.toLowerCase()) && 
                            (line.endsWith(targetWord) || 
                            line.endsWith(targetWord + '.') || 
                            line.endsWith(targetWord + '!') || 
                            line.endsWith(targetWord + '?') ||
                            line.endsWith(targetWord + ','))
                        );
                        
                        if (!isAlsoLineEnding) {
                            totalCount++;
                        }
                    }
                    
                    if (totalCount > 0) {
                        problematicWords[targetWord] = totalCount;
                    }
                });
                
                // Convert to array and sort by frequency
                return Object.entries(problematicWords)
                    .map(([word, count]) => ({ word: word, count: count }))
                    .sort((a, b) => b.count - a.count);
            }

            // Helper function to get the last word of a string
            function getLastWord(text) {
                if (!text) return null;
                
                // Remove punctuation at the very end
                const cleanText = text.trim().replace(/[.,!?;:"']+$/, '');
                
                // Get the last word
                const words = cleanText.split(/\s+/);
                return words[words.length - 1];
            }

            // Initialize all tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Process content changes with debouncing for better performance
            const processContentChanges = debounce(function() {
                // Simply update word counts and highlight art notes
                updateWordCounts();
            }, 300);

            // Monitor quill content changes
            quill.on('text-change', processContentChanges);

            // Paste handler
            quill.root.addEventListener('paste', function(e) {
                // Allow a little time for Quill to handle the paste
                setTimeout(function() {
                    processContentChanges();
                }, 100);
            });

            // Initial processing
            setTimeout(function() {
                updateWordCounts();
            }, 100);

            // Helper Functions
            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            function getPlainTextFromEditor() {
                // Get text directly from Quill
                return quill.getText().trim();
            }

            function getWordsFromText(text) {
                if (!text || text.trim() === '') {
                    return [];
                }
                
                // Clean the text and split into words
                /*return text.toLowerCase()
                    .replace(/[.,\/#—!$%\^&\*;:{}=\_\-`''~()"?""…\[\]]/g, ' ')
                    .replace(/\s{2,}/g, ' ')
                    .trim()
                    .split(/\s+/);*/
                
                return text.toLowerCase()
                    .replace(/[“”.,\/#—!$%\^&\*;:{}=\_`''~()?"…\[\]]/g, ' ')
                    .replace(/(^|\s)-|-(\s|$)/g, ' ')
                    .replace(/\s{2,}/g, ' ')
                    .trim()
                    .split(/\s+/);

            }

            function getNestedArtNotes(text) {
                const results = [];
                const stack = [];
                // Iterate over every character in the text.
                for (let i = 0; i < text.length; i++) {
                    if (text[i] === '[') {
                        // Push the index of the opening bracket onto the stack.
                        stack.push(i);
                    } else if (text[i] === ']' && stack.length > 0) {
                        // Pop the most recent opening bracket index.
                        const start = stack.pop();
                        // If the stack is empty, we have a top-level bracketed segment.
                        if (stack.length === 0) {
                            const segment = text.substring(start, i + 1);
                            // Optionally ignore inline markers like [EC1] (letters and digits, no spaces)
                            if (!/^\[[A-Za-z]+\d+\]$/.test(segment)) {
                                results.push({ index: start, length: i - start + 1, text: segment });
                            }
                        }
                    }
                }
                return results;
            }
            
            function getWordFrequencies(text) {
                const words = getWordsFromText(text);
                if (words.length === 0) {
                    return [];
                }
                
                const freqMap = {};
                
                // Filter out art notes and stop words
                const cleanText = removeArtNotes(text);
                const filteredWords = getWordsFromText(cleanText)
                    .filter(word => !stopWords.includes(word) && word.length > 1);
                
                // Count word frequencies
                filteredWords.forEach(word => {
                    if (freqMap[word]) {
                        freqMap[word]++;
                    } else {
                        freqMap[word] = 1;
                    }
                });
                
                // Convert to array and sort by frequency
                const sortedFreq = Object.entries(freqMap)
                    .map(([word, count]) => ({ text: word, size: count }))
                    .sort((a, b) => b.size - a.size)
                    .slice(0, 100); // Limit to top 100 words
                
                return sortedFreq;
            }
            
            function removeArtNotes(text) {
                // Get art notes using the new function
                const artNotes = findArtNotes(text);
                
                // Sort art notes in reverse order (to avoid index shifting when removing)
                artNotes.sort((a, b) => b.start - a.start);
                
                // Create a copy of the text
                let cleanText = text;
                
                // Remove each art note from the text
                artNotes.forEach(note => {
                    cleanText = cleanText.substring(0, note.start) + ' ' + cleanText.substring(note.end + 1);
                });
                
                return cleanText;
            }

            // Comprehensive art note detection function that handles nested parentheses
            function findArtNotes(text) {
                const artNotes = [];
                let bracketDepth = 0;
                let parenDepth = 0;
                let currentArtNote = "";
                let startIndex = -1;
                let inBracketArtNote = false;
                let inParenArtNote = false;
                
                // For parenthetical art notes, we need keywords
                const artNoteKeywords = ["art note", "illo", "illus", "illustration note", "action note"];
                
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    
                    // Handle square bracket art notes
                    if (char === '[' && !inParenArtNote) {
                        if (bracketDepth === 0) {
                            // Start of a potential art note
                            startIndex = i;
                            currentArtNote = "[";
                            inBracketArtNote = true;
                        } else {
                            // Nested brackets inside art note
                            currentArtNote += char;
                        }
                        bracketDepth++;
                    } 
                    else if (char === ']' && inBracketArtNote) {
                        bracketDepth--;
                        currentArtNote += char;
                        
                        if (bracketDepth === 0) {
                            // End of art note
                            artNotes.push({
                                text: currentArtNote,
                                start: startIndex,
                                end: i
                            });
                            currentArtNote = "";
                            inBracketArtNote = false;
                        }
                    }
                    // Handle parenthetical art notes
                    else if (char === '(' && !inBracketArtNote) {
                        if (parenDepth === 0) {
                            // This might be the start of a parenthetical art note
                            // We'll need to check if it contains art note keywords
                            startIndex = i;
                            currentArtNote = "(";
                            inParenArtNote = true;
                        } else if (inParenArtNote) {
                            // Nested parentheses
                            currentArtNote += char;
                        }
                        parenDepth++;
                    }
                    else if (char === ')' && inParenArtNote) {
                        parenDepth--;
                        currentArtNote += char;
                        
                        if (parenDepth === 0) {
                            // Check if this parenthetical note contains any art note keywords
                            const noteText = currentArtNote.toLowerCase();
                            const isArtNote = artNoteKeywords.some(keyword => noteText.includes(keyword));
                            
                            if (isArtNote) {
                                artNotes.push({
                                    text: currentArtNote,
                                    start: startIndex,
                                    end: i
                                });
                            }
                            
                            currentArtNote = "";
                            inParenArtNote = false;
                        }
                    }
                    else if (inBracketArtNote || inParenArtNote) {
                        currentArtNote += char;
                    }
                }
                
                return artNotes;
            }
            
            function detectSpecialWords(text, wordList) {
                // Remove art notes from the text first
                const textWithoutArtNotes = removeArtNotes(text);
                
                // Get words from the text without art notes
                const words = getWordsFromText(textWithoutArtNotes);
                
                // Find words from the provided list in the text
                const specialWordsFound = {};
                
                words.forEach(word => {
                    if (wordList.includes(word)) {
                        if (specialWordsFound[word]) {
                            specialWordsFound[word]++;
                        } else {
                            specialWordsFound[word] = 1;
                        }
                    }
                });
                
                // Convert to array and sort by frequency
                return Object.entries(specialWordsFound)
                    .map(([word, count]) => ({ word: word, count: count }))
                    .sort((a, b) => b.count - a.count);
            }
            
            // First, let's update the displaySpecialWordsList function to add the clickable behavior
            function displaySpecialWordsList(wordsList, elementId, title) {
                const container = document.getElementById(elementId);
                container.innerHTML = '';
                
                if (wordsList.length === 0) {
                    container.innerHTML = `<div class="alert alert-info">No ${title.toLowerCase()} found in your text.</div>`;
                    return;
                }
                
                wordsList.forEach(item => {
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.style.cursor = 'pointer'; // Add cursor pointer
                    listItem.innerHTML = `
                        <span>${capitalizeFirstLetter(item.word)}</span>
                        <span class="badge bg-primary rounded-pill">${item.count}</span>
                    `;
                    // Add hover effect
                    listItem.addEventListener('mouseover', () => {
                        listItem.style.backgroundColor = '#f8f9fa';
                    });
                    listItem.addEventListener('mouseout', () => {
                        listItem.style.backgroundColor = '';
                    });
                    // Add click event for word highlighting
                    listItem.addEventListener('click', () => {
                        highlightWordInstances(item.word);
                    });
                    container.appendChild(listItem);
                });
            }           

            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
            
            function displayWordFrequencies(wordFrequencies) {
                const container = document.getElementById('word-freq-list');
                container.innerHTML = '';
                
                if (wordFrequencies.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">No significant words found in your text.</div>';
                    return;
                }
                
                wordFrequencies.slice(0, 30).forEach(item => { // Show top 30
                    const listItem = document.createElement('div');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.style.cursor = 'pointer'; // Add cursor pointer
                    listItem.innerHTML = `
                        <span>${capitalizeFirstLetter(item.text)}</span>
                        <span class="badge bg-primary rounded-pill">${item.size}</span>
                    `;
                    // Add hover effect
                    listItem.addEventListener('mouseover', () => {
                        listItem.style.backgroundColor = '#f8f9fa';
                    });
                    listItem.addEventListener('mouseout', () => {
                        listItem.style.backgroundColor = '';
                    });
                    // Add click event for word highlighting
                    listItem.addEventListener('click', () => {
                        highlightWordInstances(item.text);
                    });
                    container.appendChild(listItem);
                });
            }

            // Add this variable outside of any function to track currently highlighted word
            let currentHighlightedWord = null;

            // Add this function to highlight word instances in the editor
            function highlightWordInstances(word) {
                // Clear previous highlights if different word
                if (currentHighlightedWord !== word) {
                    clearWordHighlights();
                }
                
                currentHighlightedWord = word;
                
                // Get the text content
                const text = quill.getText();
                
                // Create a regex to find all instances of the word with word boundaries
                const wordRegex = new RegExp(`\\b${word}\\b`, 'gi');
                
                let match;
                // Reset lastIndex
                wordRegex.lastIndex = 0;
                
                // Find and highlight all instances
                while ((match = wordRegex.exec(text)) !== null) {
                    quill.formatText(match.index, match[0].length, {
                        'background': 'yellow'
                    });
                }
                
                // Preserve art note formatting
                highlightArtNotes();
            }

            // Add this function to clear word highlights
            function clearWordHighlights() {
                if (!currentHighlightedWord) return;
                
                // Get the full text length
                const text = quill.getText();
                
                // Remove all yellow background formatting at once instead of iterating through Delta ops
                quill.formatText(0, text.length, {
                    'background': false
                });
                
                currentHighlightedWord = null;
                
                // Re-apply art note highlighting
                highlightArtNotes();
            }
            
            function generateWordCloud(words, containerId) {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                
                if (words.length === 0) {
                    container.innerHTML = '<div class="alert alert-info">Not enough text to generate a word cloud.</div>';
                    return;
                }
                
                const width = container.offsetWidth;
                const height = container.offsetHeight;
                
                // Scale word sizes for better visual appearance
                const maxSize = words[0].size;
                const minSize = words[words.length - 1].size;
                const fontSizeScale = d3.scaleLinear()
                    .domain([minSize, maxSize])
                    .range([14, 50]);
                    
                words.forEach(d => {
                    d.size = fontSizeScale(d.size);
                });
                
                // Generate cloud layout
                d3.layout.cloud()
                    .size([width, height])
                    .words(words)
                    .padding(5)
                    .rotate(() => ~~(Math.random() * 2) * 90)
                    .font("Impact")
                    .fontSize(d => d.size)
                    .on("end", drawWordCloud)
                    .start();
                    
                function drawWordCloud(words) {
                    // Create SVG
                    const svg = d3.select(`#${containerId}`).append("svg")
                        .attr("width", width)
                        .attr("height", height)
                        .append("g")
                        .attr("transform", `translate(${width/2},${height/2})`);
                        
                    // Add words
                    svg.selectAll("text")
                        .data(words)
                        .enter().append("text")
                        .style("font-size", d => `${d.size}px`)
                        .style("font-family", "Impact")
                        .style("fill", () => d3.schemeCategory10[Math.floor(Math.random() * 10)])
                        .style("cursor", "pointer") // Add cursor pointer
                        .attr("text-anchor", "middle")
                        .attr("transform", d => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
                        .text(d => d.text)
                        .on("click", (event, d) => { // Add click event handler
                            highlightWordInstances(d.text);
                        });
                }
            }
            
            function updateWordCounts() {
                // Get text content
                const text = getPlainTextFromEditor();
                
                // Handle empty editor case
                if (!text || text.trim() === '') {
                    document.getElementById('text-word-count').textContent = '0';
                    document.getElementById('art-notes-word-count').textContent = '0';
                    document.getElementById('total-word-count').textContent = '0';
                    document.getElementById('art-notes-count').textContent = '0';
                    return;
                }
                
                // Define counters
                let textWordCount = 0;
                let artNotesWordCount = 0;
                let totalWordCount = 0;
                
                // Find all art notes using improved function
                const artNotes = findArtNotes(text);
                const artNotesCount = artNotes.length;
                
                // Count words in art notes
                artNotes.forEach(note => {
                    const artNoteWords = getWordsFromText(note.text);
                    artNotesWordCount += artNoteWords.length;
                });
                
                // Count words in text without art notes
                const textWithoutArtNotes = removeArtNotes(text);
                const textWords = getWordsFromText(textWithoutArtNotes);
                textWordCount = textWords.length;
                
                // Calculate total
                totalWordCount = textWordCount + artNotesWordCount;
                
                // Update statistics display
                document.getElementById('text-word-count').textContent = textWordCount;
                document.getElementById('art-notes-word-count').textContent = artNotesWordCount;
                document.getElementById('total-word-count').textContent = totalWordCount;
                document.getElementById('art-notes-count').textContent = artNotesCount;
                
                // Apply highlighting
                highlightArtNotes();
            }
            
            function highlightArtNotes() {
                // Get the text to search for art notes
                const text = quill.getText();
                
                // Find art notes using improved function
                const artNotes = findArtNotes(text);
                
                // We'll need to save any yellow background formatting first
                let yellowHighlights = [];
                if (currentHighlightedWord) {
                    // Find all instances of the currently highlighted word
                    const wordRegex = new RegExp(`\\b${currentHighlightedWord}\\b`, 'gi');
                    let match;
                    wordRegex.lastIndex = 0;
                    
                    while ((match = wordRegex.exec(text)) !== null) {
                        yellowHighlights.push({
                            index: match.index,
                            length: match[0].length
                        });
                    }
                }
                
                // Apply formatting to art notes
                artNotes.forEach(note => {
                    // Calculate length (end - start is the index difference, but we need length)
                    const length = note.end - note.start + 1;
                    
                    try {
                        quill.formatText(note.start, length, {
                            'color': '#d9534f',
                            'italic': true,
                            'background': 'rgba(217, 83, 79, 0.1)'
                        });
                    } catch (e) {
                        console.error('Error formatting art note:', e);
                    }
                });
                
                // Re-apply yellow highlights for words
                yellowHighlights.forEach(highlight => {
                    quill.formatText(highlight.index, highlight.length, {
                        'background': 'yellow'
                    });
                });
            }
            
            function findAllMatches(text, regex) {
                // Helper function to find all regex matches with their positions
                const matches = [];
                let match;
                
                // Create a new RegExp to reset lastIndex
                const re = new RegExp(regex);
                
                while ((match = re.exec(text)) !== null) {
                    matches.push({
                        index: match.index,
                        length: match[0].length,
                        text: match[0]
                    });
                    
                    // Avoid infinite loops with zero-length matches
                    if (match.index === re.lastIndex) {
                        re.lastIndex++;
                    }
                }
                
                return matches;
            }

            function mergeOverlappingMatches(matches) {
                if (matches.length === 0) return [];
                // Sort matches by their starting index
                matches.sort((a, b) => a.index - b.index);
                let merged = [];
                let current = matches[0];
                for (let i = 1; i < matches.length; i++) {
                    let m = matches[i];
                    // If the match is completely nested inside the current match, skip it.
                    if (m.index >= current.index && (m.index + m.length) <= (current.index + current.length)) {
                        continue;
                    } else {
                        merged.push(current);
                        current = m;
                    }
                }
                merged.push(current);
                return merged;
            }
        //});

        //document.addEventListener('DOMContentLoaded', function() {
        // Initialize Firebase Authentication
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Email/Password Login
        document.getElementById('login-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Clear previous error messages
            document.getElementById('auth-message').innerHTML = '';
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Logging in...';
            
            // Sign in with email and password
            auth.signInWithEmailAndPassword(email, password)
            .catch((error) => {
                // Handle errors
                let errorMessage = 'Login failed. Please check your email and password.';
                if (error.code === 'auth/user-not-found') {
                errorMessage = 'No account found with this email. Please sign up.';
                } else if (error.code === 'auth/wrong-password') {
                errorMessage = 'Incorrect password. Please try again or reset your password.';
                }
                
                document.getElementById('auth-message').innerHTML = `
                <div class="alert alert-danger">${errorMessage}</div>
                `;
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        });
        
        // Email/Password Signup
        document.getElementById('signup-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            //const newsletter = document.getElementById('newsletter-consent').checked;
            
            // Clear previous error messages
            document.getElementById('auth-message').innerHTML = '';
            
            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating account...';
            
            // Create user with email and password
            auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Store user in database with newsletter preference
                db.collection('users').doc(userCredential.user.uid).set({
                email: email,
                //newsletter_subscribed: newsletter,
                signup_date: firebase.firestore.FieldValue.serverTimestamp(),
                //added_to_substack: false
                });
            })
            .catch((error) => {
                // Handle errors
                let errorMessage = 'Sign up failed. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                errorMessage = 'An account already exists with this email. Please log in instead.';
                } else if (error.code === 'auth/weak-password') {
                errorMessage = 'Password is too weak. Please use at least 6 characters.';
                }
                
                document.getElementById('auth-message').innerHTML = `
                <div class="alert alert-danger">${errorMessage}</div>
                `;
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        });
        
        // Google Authentication
        document.getElementById('google-login-btn')?.addEventListener('click', function() {
            const provider = new firebase.auth.GoogleAuthProvider();
            signInWithProvider(provider);
        });
               
        function signInWithProvider(provider, newsletter = true) {
            auth.signInWithPopup(provider)
            .then((result) => {
                // Check if it's a new user
                if (result.additionalUserInfo.isNewUser) {
                // Store user in database with newsletter preference
                db.collection('users').doc(result.user.uid).set({
                    email: result.user.email,
                    newsletter_subscribed: newsletter,
                    signup_date: firebase.firestore.FieldValue.serverTimestamp(),
                    added_to_substack: false
                });
                }
            })
            .catch((error) => {
                console.error('Error during social authentication:', error);
                document.getElementById('auth-message').innerHTML = `
                <div class="alert alert-danger">Authentication failed. Please try a different method.</div>
                `;
            });
        }
        
        // Password Reset
        document.getElementById('forgot-password-link')?.addEventListener('click', function(e) {
            e.preventDefault();
            const resetModal = new bootstrap.Modal(document.getElementById('password-reset-modal'));
            resetModal.show();
        });
        
        document.getElementById('reset-password-btn')?.addEventListener('click', function() {
            const email = document.getElementById('reset-email').value;
            if (!email) {
            document.getElementById('reset-message').innerHTML = `
                <div class="alert alert-danger">Please enter your email address.</div>
            `;
            return;
            }
            
            // Show loading state
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
            
            auth.sendPasswordResetEmail(email)
            .then(() => {
                document.getElementById('reset-message').innerHTML = `
                <div class="alert alert-success">Password reset email sent! Check your inbox.</div>
                `;
                setTimeout(() => {
                const resetModal = bootstrap.Modal.getInstance(document.getElementById('password-reset-modal'));
                resetModal.hide();
                }, 2000);
            })
            .catch((error) => {
                let errorMessage = 'Failed to send reset email. Please try again.';
                if (error.code === 'auth/user-not-found') {
                errorMessage = 'No account found with this email.';
                }
                document.getElementById('reset-message').innerHTML = `
                <div class="alert alert-danger">${errorMessage}</div>
                `;
            })
            .finally(() => {
                // Reset button
                this.disabled = false;
                this.innerHTML = 'Send Reset Link';
            });
        });

        // Remove word highlighting when you close the word frequency accordion
        document.getElementById('wordFrequencyCollapse').addEventListener('hidden.bs.collapse', function () {
            clearWordHighlights();
        });
        document.getElementById('wordCloudCollapse').addEventListener('hidden.bs.collapse', function () {
            clearWordHighlights();
        });
        document.getElementById('adverbsCollapse').addEventListener('hidden.bs.collapse', function () {
            clearWordHighlights();
        });
        document.getElementById('rhymeWordsCollapse').addEventListener('hidden.bs.collapse', function () {
            clearWordHighlights();
        });

        // Art note deletion functionality
        document.getElementById('delete-art-notes').addEventListener('click', function() {
            // Get current text
            const text = quill.getText();
            
            // Find all art notes
            const artNotes = findArtNotes(text);
            
            // If no art notes, show modal and return
            if (artNotes.length === 0) {
                const noArtNotesModal = new bootstrap.Modal(document.getElementById('noArtNotesModal'));
                noArtNotesModal.show();
                return;
            }
            
            // Update confirmation text with count
            document.getElementById('confirm-delete-text').textContent = 
                `Are you sure you want to delete all ${artNotes.length} art note${artNotes.length === 1 ? '' : 's'} from your manuscript? This action cannot be undone.`;
            
            // Show confirmation dialog
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            confirmModal.show();
            
            // Handle confirmation button click
            document.getElementById('confirm-delete-btn').onclick = function() {
                // Close the confirmation modal
                confirmModal.hide();
                
                // Get the original text content and split into lines
                const originalText = quill.getText();
                const originalLines = originalText.split('\n');
                
                // Map art notes to their line numbers
                const artNoteLines = mapArtNotesToLines(artNotes, originalText);
                
                // Sort art notes in reverse order (to avoid index shifting when removing)
                artNotes.sort((a, b) => b.start - a.start);
                
                // Store current selection if any
                const currentSelection = quill.getSelection();
                
                // Delete each art note
                artNotes.forEach(note => {
                    quill.deleteText(note.start, note.end - note.start + 1);
                });
                
                // After deleting art notes, check which lines contained ONLY art notes
                setTimeout(() => {
                    // Get updated text content
                    const updatedText = quill.getText();
                    const updatedLines = updatedText.split('\n');
                    
                    // Find lines that became empty due to art note removal
                    cleanupEmptyArtNoteLines(originalLines, updatedLines, artNoteLines);
                    
                    // Update word counts and other stats
                    updateWordCounts();
                    
                    // Restore selection if applicable
                    if (currentSelection) {
                        // Get updated content to calculate proper position
                        const finalText = quill.getText();
                        const adjustedIndex = Math.min(currentSelection.index, finalText.length - 1);
                        quill.setSelection(Math.max(0, adjustedIndex), 0);
                    }
                }, 0);
                
                // Show success message with appropriate singular/plural
                document.getElementById('success-delete-text').textContent = 
                    `Successfully removed ${artNotes.length} art note${artNotes.length === 1 ? '' : 's'} from your manuscript.`;
                
                // Show success modal
                setTimeout(() => {
                    const successModal = new bootstrap.Modal(document.getElementById('successDeleteModal'));
                    successModal.show();
                }, 300); // Small delay to allow confirmation modal to fully close
            };
        });

        // Maps art notes to their line numbers in the text
        function mapArtNotesToLines(artNotes, text) {
            const lines = text.split('\n');
            const artNoteLines = {};
            
            // Create a map to track which lines contain art notes
            let charPos = 0;
            for (let i = 0; i < lines.length; i++) {
                const lineEndPos = charPos + lines[i].length;
                
                // Check each art note to see if it falls on this line
                for (const note of artNotes) {
                    // If the art note overlaps with this line
                    if (note.start <= lineEndPos && note.end >= charPos) {
                        // Store what percentage of the line is occupied by the art note
                        const lineLength = lines[i].length;
                        
                        // Calculate overlap
                        const overlapStart = Math.max(note.start, charPos);
                        const overlapEnd = Math.min(note.end, lineEndPos);
                        const overlapLength = overlapEnd - overlapStart + 1;
                        
                        // Calculate coverage percentage
                        const coverage = lineLength > 0 ? (overlapLength / lineLength) : 0;
                        
                        if (!artNoteLines[i]) {
                            artNoteLines[i] = { 
                                lineContent: lines[i],
                                notes: [],
                                totalCoverage: 0
                            };
                        }
                        
                        artNoteLines[i].notes.push({
                            start: Math.max(0, note.start - charPos),
                            end: Math.min(lineLength, note.end - charPos),
                            coverage: coverage
                        });
                        
                        artNoteLines[i].totalCoverage += coverage;
                    }
                }
                
                // Move to the next line (add 1 for the newline character)
                charPos = lineEndPos + 1;
            }
            
            return artNoteLines;
        }

        // Cleans up lines that were entirely (or almost entirely) art notes
        function cleanupEmptyArtNoteLines(originalLines, updatedLines, artNoteLines) {
            // Counter to track line position shifts
            let lineOffset = 0;
            
            // Check each line that had art notes
            for (const lineNum in artNoteLines) {
                const lineIdx = parseInt(lineNum);
                const lineInfo = artNoteLines[lineNum];
                
                // Check if this line had high art note coverage (>90%)
                if (lineInfo.totalCoverage > 0.9) {
                    // Adjust for previous deletions
                    const adjustedLineIdx = lineIdx - lineOffset;
                    
                    // Make sure the line index is valid
                    if (adjustedLineIdx >= 0 && adjustedLineIdx < updatedLines.length) {
                        // Check if the line is now empty or just whitespace
                        if (updatedLines[adjustedLineIdx].trim() === '') {
                            // Calculate the position of this line in the document
                            let position = 0;
                            for (let i = 0; i < adjustedLineIdx; i++) {
                                position += updatedLines[i].length + 1; // +1 for newline
                            }
                            
                            // Delete the empty line (including its newline)
                            if (adjustedLineIdx < updatedLines.length - 1) {
                                // Not the last line - delete line and newline
                                quill.deleteText(position, updatedLines[adjustedLineIdx].length + 1);
                            } else if (adjustedLineIdx > 0) {
                                // Last line - delete the preceding newline and the line
                                quill.deleteText(position - 1, updatedLines[adjustedLineIdx].length + 1);
                            } else {
                                // First and only line - just delete content
                                quill.deleteText(position, updatedLines[adjustedLineIdx].length);
                            }
                            
                            // Increment offset for subsequent lines
                            lineOffset++;
                            
                            // Update the updated lines array after deletion
                            updatedLines.splice(adjustedLineIdx, 1);
                        }
                    }
                }
            }
        }

        
        

        });

        function addLogoutButton() {
            const headerDiv = document.querySelector('header > div');
            
            // Remove any previous authentication state listeners
            if (window.authStateUnsubscribe) {
                window.authStateUnsubscribe();
            }

            // Create a single logout button
            let logoutButton = document.getElementById('logout-button');
            if (!logoutButton) {
                logoutButton = document.createElement('button');
                logoutButton.id = 'logout-button';
                logoutButton.className = 'btn btn-outline-secondary ms-2';
                logoutButton.addEventListener('click', function() {
                    firebase.auth().signOut().then(() => {
                        document.getElementById('login-section').style.display = 'block';
                        document.getElementById('editor-section').style.display = 'none';
                    });
                });
            }

            // Set up the authentication state listener
            window.authStateUnsubscribe = firebase.auth().onAuthStateChanged(function(user) {
                // Remove any existing logout buttons first
                const existingButtons = headerDiv.querySelectorAll('#logout-button');
                existingButtons.forEach(btn => headerDiv.removeChild(btn));

                if (user) {
                    // Update button text and append 
                    const username = user.email.split('@')[0];
                    logoutButton.innerHTML = `<i class="fas fa-sign-out-alt me-2"></i>${username} (Logout)`;
                    headerDiv.appendChild(logoutButton);
                } else {
                    // Reset the login form submit button when logged out
                    const loginForm = document.getElementById('login-form');
                    if (loginForm) {
                        const submitBtn = loginForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Log In';
                    }
                }
            });
        }
        
    </script>
</body>
</html>